name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  DEPLOY_ENVIRONMENT_NAME: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}

jobs:
  quality-checks:
    name: Static analysis and build verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run lint/type-check
        run: npm run lint

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=2048" npm run build

  ssh-test:
    name: Verify SSH connectivity
    runs-on: ubuntu-latest
    needs: quality-checks
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Validate connection settings
        run: |
          if [ -z "${SSH_HOST}" ]; then
            echo "::error::Missing SSH host. Please define a secret or variable such as SSH_HOST or IP." >&2
            exit 1
          fi
          if [ -z "${SSH_USER}" ]; then
            echo "::error::Missing SSH username. Please define a secret or variable such as SSH_USER or USER." >&2
            exit 1
          fi
          if [ -z "${SSH_PASSWORD}" ]; then
            echo "::error::Missing SSH password. Please define a secret or variable such as SSH_PASSWORD, PASS, or PASSWORD." >&2
            exit 1
          fi

      - name: Test SSH connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            echo "SSH connection successful"

      - name: Ensure Nginx is installed and configured
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            if ! command -v nginx >/dev/null 2>&1; then
              export DEBIAN_FRONTEND=noninteractive
              $SUDO apt-get clean || true
              $SUDO rm -rf /var/lib/apt/lists/* || true
              $SUDO apt-get update --allow-releaseinfo-change || $SUDO apt-get update || true
              $SUDO apt-get install -y nginx
            fi

            SITE_CONF="/etc/nginx/sites-available/sphynx-ir"
            SITE_LINK="/etc/nginx/sites-enabled/sphynx-ir"

            $SUDO tee "$SITE_CONF" >/dev/null <<'EOF'
            server {
                listen 80;
                listen [::]:80;
                server_name sphynx.ir www.sphynx.ir;

                # Redirect HTTP to HTTPS
                return 301 https://$host$request_uri;
            }

            server {
                listen 443 ssl;
                listen [::]:443 ssl;
                server_name sphynx.ir www.sphynx.ir;

                ssl_certificate /etc/letsencrypt/live/sphynx.ir/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/sphynx.ir/privkey.pem;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
                ssl_prefer_server_ciphers off;

                location / {
                    proxy_pass http://127.0.0.1:3003;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }
            }
            EOF

            $SUDO ln -sf "$SITE_CONF" "$SITE_LINK"

            if [ -e /etc/nginx/sites-enabled/default ]; then
              $SUDO rm -f /etc/nginx/sites-enabled/default
            fi

            $SUDO nginx -t
            $SUDO systemctl restart nginx

      - name: Install Certbot and Nginx dependencies
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            export DEBIAN_FRONTEND=noninteractive
            
            # Fix GPG key and systemd issues by cleaning apt cache and lists
            $SUDO apt-get clean || true
            $SUDO rm -rf /var/lib/apt/lists/* || true
            $SUDO mkdir -p /var/lib/apt/lists/partial || true
            
            # Disable problematic apt hooks that might cause systemd issues
            $SUDO mkdir -p /etc/apt/apt.conf.d || true
            echo 'APT::Update::Pre-Invoke "true";' | $SUDO tee /etc/apt/apt.conf.d/99disable-hooks >/dev/null || true
            
            # Update package lists with error handling
            # Use --allow-releaseinfo-change to handle repository metadata changes
            $SUDO apt-get update --allow-releaseinfo-change 2>&1 || {
              # If update fails, try to fix GPG keys and retry
              echo "First update attempt failed, fixing GPG keys..."
              $SUDO apt-get install -y --reinstall ca-certificates 2>/dev/null || true
              $SUDO apt-get update --allow-releaseinfo-change 2>&1 || $SUDO apt-get update 2>&1 || true
            }
            
            # Install Certbot and dependencies
            $SUDO apt-get install -y certbot python3-certbot-nginx

            # Open ports 80 and 443 (if needed, check your firewall)
            $SUDO ufw allow 'Nginx Full' || true

            # Reload Nginx after installing Certbot
            $SUDO systemctl reload nginx || true

      - name: Generate SSL certificate with Certbot
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            # Obtain SSL certificate for the domain
            $SUDO certbot --nginx -d sphynx.ir -d www.sphynx.ir --non-interactive --agree-tos -m rahjooh@yahoo.com --force-renewal

            # Reload Nginx to apply SSL
            $SUDO systemctl reload nginx

  deploy:
    name: Deploy to sphynx.ir
    runs-on: ubuntu-latest
    needs: ssh-test
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=4096" npm run build

      - name: Verify build output
        run: |
          if [ ! -d ".next" ]; then
            echo "::error::Build failed - .next directory not found"
            exit 1
          fi
          echo "Build output verified: .next directory exists"

      - name: Prepare deployment archive
        run: |
          set -euo pipefail

          ARCHIVE_PATH="${RUNNER_TEMP}/deploy.tar.gz"

          # Remove dev dependencies and keep only production files
          rm -rf node_modules
          rm -f "$ARCHIVE_PATH" deploy.tar.gz

          # Create archive with source files and build output
          # Note: .next/cache is excluded but .next/standalone and .next/static are included
          tar czf "$ARCHIVE_PATH" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='deploy.tar.gz' \
            --exclude='deploy.tar.gz.*' \
            --exclude='.next/cache' \
            .

          mv "$ARCHIVE_PATH" ./deploy.tar.gz
          echo "Deployment archive created successfully"

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload archive to server
        env:
          SSH_PORT: ${{ env.SSH_PORT }}
        run: |
          set -euo pipefail

          SSH_PORT="${SSH_PORT:-22}"
          REMOTE="${SSH_USER}@${SSH_HOST}"
          REMOTE_DIR="~/deployments"
          ARCHIVE_NAME="deploy.tar.gz"
          REMOTE_PATH="$REMOTE_DIR/$ARCHIVE_NAME"
          RETRIES=5
          SLEEP_BETWEEN=10

          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p "$SSH_PORT" "$REMOTE" "mkdir -p ${REMOTE_DIR}"

          for attempt in $(seq 1 "$RETRIES"); do
            echo "Uploading archive (attempt ${attempt}/${RETRIES})"
            if sshpass -p "$SSH_PASSWORD" \
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 -P "$SSH_PORT" "$ARCHIVE_NAME" "$REMOTE:$REMOTE_PATH"; then
              echo "Upload complete"
              exit 0
            fi

            if [ "$attempt" -lt "$RETRIES" ]; then
              echo "Upload failed, retrying in ${SLEEP_BETWEEN}s"
              sleep "$SLEEP_BETWEEN"
            else
              echo "::error::Failed to upload archive after ${RETRIES} attempts"
              exit 1
            fi
          done

      - name: Deploy on remote host
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            ARCHIVE_DIR="$HOME/deployments"
            ARCHIVE_NAME="deploy.tar.gz"
            ARCHIVE_PATH="$ARCHIVE_DIR/$ARCHIVE_NAME"
            APP_DIR="$HOME/apps/sphynx.ir"
            APP_NAME="sphynx-ir"

            mkdir -p "$ARCHIVE_DIR"

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            export DEBIAN_FRONTEND=noninteractive
            export APT_LISTCHANGES_FRONTEND=none

            UPDATED=0
            apt_update_once() {
              if [ "$UPDATED" -eq 0 ]; then
                $SUDO apt-get update -o Dpkg::Use-Pty=0
                UPDATED=1
              fi
            }

            apt_install() {
              apt_update_once
              $SUDO apt-get install -y -o Dpkg::Use-Pty=0 "$@"
            }

            if ! command -v curl >/dev/null 2>&1; then
              apt_install curl
            fi

            if ! command -v node >/dev/null 2>&1; then
              apt_install ca-certificates gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | $SUDO bash -
              apt_install nodejs
            fi

            if ! command -v setcap >/dev/null 2>&1; then
              apt_install libcap2-bin
            fi

            if ! command -v pm2 >/dev/null 2>&1; then
              $SUDO npm install -g pm2
            fi

            if command -v pm2 >/dev/null 2>&1 && pm2 describe "$APP_NAME" >/dev/null 2>&1; then
              pm2 stop "$APP_NAME"
              pm2 delete "$APP_NAME"
            fi

            rm -rf "$APP_DIR"
            mkdir -p "$APP_DIR"
            tar -xzf "$ARCHIVE_PATH" -C "$APP_DIR" --strip-components=1
            rm -f "$ARCHIVE_PATH"

            cd "$APP_DIR"
            
            # Install only production dependencies (build is already done in GitHub Actions)
            npm ci --omit=dev

            if [ -n "$SUDO" ]; then
              NODE_BIN="$(command -v node || true)"
              if [ -n "$NODE_BIN" ]; then
                $SUDO setcap 'cap_net_bind_service=+ep' "$NODE_BIN" || true
              fi
            fi

            APP_PORT=3003

            pm2 start npm --name "$APP_NAME" -- run start -- --hostname 0.0.0.0 --port "$APP_PORT"
            if [ -n "$SUDO" ]; then
              $SUDO pm2 startup systemd -u "$(whoami)" --hp "$HOME" || true
            fi
            pm2 save

            if command -v nginx >/dev/null 2>&1; then
              if command -v systemctl >/dev/null 2>&1; then
                $SUDO systemctl reload nginx || $SUDO systemctl restart nginx || true
              else
                $SUDO nginx -s reload || $SUDO service nginx reload || true
              fi
            fi
